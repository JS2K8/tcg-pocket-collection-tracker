import{c as U,r as c,ac as P,j as m,aa as N,y as L,U as R,C as T,B as I,M as X}from"./index-Bxjhd36e.js";/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],B=U("Plus",Y);function D({selected:t,setIsSelected:r,card:i,size:o="default"}){var k,$;const n=c.useRef(null),[a,u]=c.useState({x:0,y:0}),[p,e]=c.useState(!1),l=c.useRef(O(d=>u(d),50)),x=d=>{l.current({x:d.clientX,y:d.clientY})},f=c.useCallback(()=>{e(!0),window.addEventListener("mousemove",x)},[]),w=c.useCallback(()=>{e(!1),window.removeEventListener("mousemove",x)},[]);let h=0,_=0;if(n.current&&p){const d=n.current.getBoundingClientRect(),C=d.left+d.width/2,M=d.top+d.height/2;h=a.x-C,_=a.y-M}const v=(d,C,M)=>Math.min(Math.max(d,C),M),s=p?v(h/4,-10,10):0,g=p?v(-_/4,-10,10):0,y={transform:`perspective(1000px)
                   rotateY(${s}deg)
                   rotateX(${g}deg)
                   scale(${p?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:"pointer",opacity:t?1:.5,width:o==="small"?"80px":"100%",height:o==="small"?"112px":"auto"},E=P.language.split("-")[0].toUpperCase(),b=($=(k=i.image)==null?void 0:k.split("/").at(-1))==null?void 0:$.replace(/_[A-Z]{2}\.webp$/,`_${E}.webp`),S=`/images/${P.language}/${b}`;return m.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:p?10:0},children:b&&m.jsx("img",{draggable:!1,onMouseDown:()=>r==null?void 0:r(!t),ref:n,className:"card-test",style:y,src:`${S}`,alt:i.name,onMouseEnter:f,onMouseLeave:w,onError:d=>{var C;d.target.src=`/images/en-US/${(C=i.image)==null?void 0:C.split("/").at(-1)}`}})})}const O=(t,r)=>{let i=0,o=null;return(...n)=>{const a=performance.now(),u=a-i;if(u<r){o||(o=setTimeout(()=>{i=performance.now(),o=null,t(...n)},r-u));return}i=a,t(...n)}},j={};function F({card:t,useMaxWidth:r=!1}){const i=L();if(t.linkedCardID)return null;const{user:o,setIsLoginDialogOpen:n}=c.use(R),{ownedCards:a,setOwnedCards:u,setSelectedCardId:p}=c.use(T),[e,l]=c.useState(t.amount_owned||0),[x,f]=c.useState(0);c.useEffect(()=>{f(e)},[e]);const w=c.useCallback(async(s,g)=>{l(Math.max(0,g)),j[s]&&window.clearTimeout(j[s]),j[s]=window.setTimeout(async()=>{if(!o||!o.user.email)throw new Error("User not logged in");const y=a.find(b=>b.card_id===s);y?y.amount_owned=Math.max(0,g):a.push({email:o.user.email,card_id:s,amount_owned:g});const{error:E}=await N.from("collection").upsert({card_id:s,amount_owned:g,email:o.user.email});if(E)throw new Error("Error updating collection")},1e3)},[a,o,u,e]),h=c.useCallback(async s=>{if(!o){n(!0);return}await w(s,e+1)},[w]),_=c.useCallback(async s=>{if(!o){n(!0);return}await w(s,e-1)},[w]),v=async s=>{const g=s.target.value===""?0:Number.parseInt(s.target.value,10);!Number.isNaN(g)&&g>=0&&await w(t.card_id,g)};return m.jsxs("div",{className:`group flex w-fit ${r?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[m.jsx("div",{onClick:()=>p(t.card_id),children:m.jsx(D,{card:t,selected:e>0})}),m.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",t.name]}),m.jsxs("div",{className:"flex items-center gap-x-1",children:[!i.friendId&&m.jsx(I,{variant:"ghost",size:"icon",onClick:()=>_(t.card_id),className:"rounded-full",tabIndex:-1,children:m.jsx(X,{})}),m.jsx("input",{min:"0",max:"99",type:"text",disabled:!!i.friendId,value:x,onChange:v,className:"w-7 text-center border-none rounded",onFocus:s=>s.target.select()}),!i.friendId&&m.jsx(I,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>h(t.card_id),tabIndex:-1,children:m.jsx(B,{})})]})]})}const H=async(t,r,i,o,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");if(r<0)throw new Error("New amount cannot be negative");const a=[...i],u=t.map(e=>({card_id:e,amount_owned:r,email:n.user.email})),{error:p}=await N.from("collection").upsert(u);if(p)throw new Error("Error bulk updating collection");for(const e of t){const l=a.find(x=>x.card_id===e);l?(console.log("Updating existing card:",e),l.amount_owned=r):l||(console.log("Adding new card:",e),a.push({email:n.user.email,card_id:e,amount_owned:r}))}o([...a])},V=async(t,r,i,o,n)=>{if(console.log("incrementing multiple cards",t,r),!n||!n.user.email)throw new Error("User not logged in");const a=[...i],u=[];for(const e of t){const l=a.find(h=>h.card_id===e),x=(l==null?void 0:l.amount_owned)||0,f=Math.max(0,x+r),w=u.find(h=>h.card_id===e);w?w.amount_owned=f:u.push({card_id:e,amount_owned:f,email:n.user.email}),l?(console.log("Incrementing existing card:",e,"from",x,"to",f),l.amount_owned=f):!l&&f>0&&(console.log("Adding new card:",e,"with amount",f),a.push({email:n.user.email,card_id:e,amount_owned:f}))}const{error:p}=await N.from("collection").upsert(u);if(p)throw new Error("Error bulk updating collection");o([...a])};export{F as C,D as F,B as P,V as i,H as u};
