import{c as L,r as m,ab as P,j as p,a9 as j,x as S,U as R,C as T,B as U,M as X}from"./index-DyvL0NB1.js";/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],B=L("Plus",Y);function z({selected:t,setIsSelected:r,card:i,size:o="default"}){var k,$;const n=m.useRef(null),[a,d]=m.useState({x:0,y:0}),[f,e]=m.useState(!1),c=m.useRef(D(u=>d(u),50)),w=u=>{c.current({x:u.clientX,y:u.clientY})},l=m.useCallback(()=>{e(!0),window.addEventListener("mousemove",w)},[]),h=m.useCallback(()=>{e(!1),window.removeEventListener("mousemove",w)},[]);let x=0,_=0;if(n.current&&f){const u=n.current.getBoundingClientRect(),C=u.left+u.width/2,E=u.top+u.height/2;x=a.x-C,_=a.y-E}const s=(u,C,E)=>Math.min(Math.max(u,C),E),g=f?s(x/4,-10,10):0,v=f?s(-_/4,-10,10):0,y={transform:`perspective(1000px)
                   rotateY(${g}deg)
                   rotateX(${v}deg)
                   scale(${f?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:"pointer",opacity:t?1:.5,width:o==="small"?"80px":"100%",height:o==="small"?"112px":"auto"},b=P.language.split("-")[0].toUpperCase(),N=($=(k=i.image)==null?void 0:k.split("/").at(-1))==null?void 0:$.replace(/_[A-Z]{2}\.webp$/,`_${b}.webp`),I=`/images/${P.language}/${N}`;return p.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:f?10:0},children:N&&p.jsx("img",{draggable:!1,onMouseDown:()=>r==null?void 0:r(!t),ref:n,className:"card-test",style:y,src:`${I}`,alt:i.name,onMouseEnter:l,onMouseLeave:h,onError:u=>{var C;u.target.src=`/images/en-US/${(C=i.image)==null?void 0:C.split("/").at(-1)}`}})})}const D=(t,r)=>{let i=0,o=null;return(...n)=>{const a=performance.now(),d=a-i;if(d<r){o||(o=setTimeout(()=>{i=performance.now(),o=null,t(...n)},r-d));return}i=a,t(...n)}},M={};function O({card:t,useMaxWidth:r=!1}){const i=S(),{user:o,setIsLoginDialogOpen:n}=m.use(R),{ownedCards:a,setOwnedCards:d,setSelectedCardId:f}=m.use(T);let e=t.amount_owned||0;const[c,w]=m.useState(0);m.useEffect(()=>{w(e)},[e]);const l=m.useCallback(async(s,g)=>{e=Math.max(0,g),w(e),M[s]&&window.clearTimeout(M[s]),M[s]=window.setTimeout(async()=>{if(!o||!o.user.email)throw new Error("User not logged in");const v=a.find(b=>b.card_id===s);v?v.amount_owned=Math.max(0,g):a.push({email:o.user.email,card_id:s,amount_owned:g}),d([...a]);const{error:y}=await j.from("collection").upsert({card_id:s,amount_owned:g,email:o.user.email});if(y)throw new Error("Error updating collection")},1e3)},[a,o,d,e]),h=m.useCallback(async s=>{if(!o){n(!0);return}await l(s,e+1)},[l]),x=m.useCallback(async s=>{if(!o){n(!0);return}await l(s,e-1)},[l]),_=async s=>{const g=s.target.value===""?0:Number.parseInt(s.target.value,10);!Number.isNaN(g)&&g>=0&&await l(t.card_id,g)};return p.jsxs("div",{className:`group flex w-fit ${r?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[p.jsx("div",{onClick:()=>f(t.card_id),children:p.jsx(z,{card:t,selected:e>0})}),p.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",t.name]}),p.jsxs("div",{className:"flex items-center gap-x-1",children:[!i.friendId&&p.jsx(U,{variant:"ghost",size:"icon",onClick:()=>x(t.card_id),className:"rounded-full",tabIndex:-1,children:p.jsx(X,{})}),p.jsx("input",{min:"0",max:"99",type:"text",disabled:!!i.friendId,value:c,onChange:_,className:"w-7 text-center border-none rounded",onFocus:s=>s.target.select()}),!i.friendId&&p.jsx(U,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>h(t.card_id),tabIndex:-1,children:p.jsx(B,{})})]})]})}const H=async(t,r,i,o,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");if(r<0)throw new Error("New amount cannot be negative");const a=[...i],d=t.map(e=>({card_id:e,amount_owned:r,email:n.user.email})),{error:f}=await j.from("collection").upsert(d);if(f)throw new Error("Error bulk updating collection");for(const e of t){const c=a.find(w=>w.card_id===e);c?(console.log("Updating existing card:",e),c.amount_owned=r):c||(console.log("Adding new card:",e),a.push({email:n.user.email,card_id:e,amount_owned:r}))}o([...a])},V=async(t,r,i,o,n)=>{if(console.log("incrementing multiple cards",t,r),!n||!n.user.email)throw new Error("User not logged in");const a=[...i],d=[];for(const e of t){const c=a.find(x=>x.card_id===e),w=(c==null?void 0:c.amount_owned)||0,l=Math.max(0,w+r),h=d.find(x=>x.card_id===e);h?h.amount_owned=l:d.push({card_id:e,amount_owned:l,email:n.user.email}),c?(console.log("Incrementing existing card:",e,"from",w,"to",l),c.amount_owned=l):!c&&l>0&&(console.log("Adding new card:",e,"with amount",l),a.push({email:n.user.email,card_id:e,amount_owned:l}))}const{error:f}=await j.from("collection").upsert(d);if(f)throw new Error("Error bulk updating collection");o([...a])};export{O as C,z as F,B as P,V as i,H as u};
