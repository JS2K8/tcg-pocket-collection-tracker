import{c as O,r as d,m as N,j as c,l as D,ax as M,J as L,U as P,C as $,B as k,M as U}from"./index-DiC0YBR6.js";/**
 * @license lucide-react v0.536.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],R=O("plus",B);function T({selected:n,setIsSelected:l,card:u,size:m="default",clickable:t=!0}){const a=d.useRef(null),[r,w]=d.useState({x:0,y:0}),[o,e]=d.useState(!1),f=d.useRef(X(i=>w(i),50)),p=i=>{f.current({x:i.clientX,y:i.clientY})},g=d.useCallback(()=>{e(!0),window.addEventListener("mousemove",p)},[]),x=d.useCallback(()=>{e(!1),window.removeEventListener("mousemove",p)},[]);let y=0,v=0;if(a.current&&o){const i=a.current.getBoundingClientRect(),I=i.left+i.width/2,E=i.top+i.height/2;y=r.x-I,v=r.y-E}const b=(i,I,E)=>Math.min(Math.max(i,I),E),s=o?b(y/4,-10,10):0,h=o?b(-v/4,-10,10):0,C={transform:`perspective(1000px)
                   rotateY(${s}deg)
                   rotateX(${h}deg)
                   scale(${o?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:t?"pointer":"default",opacity:n?1:.5,width:m==="small"?"80px":"100%",height:m==="small"?"112px":"auto"},_=u.image?.split("/").at(-1),S=`/images/${N.language}/${_}`;return c.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("firefox")?"flat":"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:o?10:0},children:_&&c.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>l?.(!n),ref:a,className:"card-test",style:C,src:S,alt:D(u,N.language),onMouseEnter:g,onMouseLeave:x,onError:i=>{i.target.src=u.image}})})}const X=(n,l)=>{let u=0,m=null;return(...t)=>{const a=performance.now(),r=a-u;if(r<l){m||(m=setTimeout(()=>{u=performance.now(),m=null,n(...t)},l-r));return}u=a,n(...t)}},j={};function z({card:n,useMaxWidth:l=!1,editable:u=!0}){const m=L(),{user:t,setIsLoginDialogOpen:a}=d.use(P),{ownedCards:r,setOwnedCards:w,setSelectedCardId:o}=d.use($),[e,f]=d.useState(n.amount_owned||0),[p,g]=d.useState(0);d.useEffect(()=>{g(e)},[e]);const x=d.useCallback(async(s,h)=>{const C=Math.max(0,h);f(C),j[s]&&window.clearTimeout(j[s]),j[s]=window.setTimeout(async()=>{if(!t||!t.user.email)throw new Error("User not logged in");const _=r.find(i=>i.card_id===s);_?_.amount_owned=C:r.push({email:t.user.email,card_id:s,amount_owned:C,updated_at:new Date().toISOString()});const{error:S}=await M.from("collection").upsert({card_id:s,amount_owned:C,email:t.user.email,updated_at:new Date().toISOString()});if(S)throw new Error("Error updating collection")},1e3)},[r,t,w,e]),y=d.useCallback(async s=>{if(!t){a(!0);return}await x(s,e+1)},[x]),v=d.useCallback(async s=>{if(!t){a(!0);return}await x(s,e-1)},[x]),b=async s=>{const h=s.target.value===""?0:Number.parseInt(s.target.value,10);!Number.isNaN(h)&&h>=0&&await x(n.card_id,h)};return n.linkedCardID?null:c.jsxs("div",{className:`group flex w-fit ${l?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg`,children:[c.jsx("button",{type:"button",className:"cursor-pointer",onClick:()=>o(n.card_id),children:c.jsx(T,{card:n,selected:e>0,clickable:!l})}),c.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[n.card_id," - ",D(n,N.language)]}),c.jsx("div",{className:"flex items-center gap-x-1",children:u&&!m.friendId?c.jsxs(c.Fragment,{children:[c.jsx(k,{variant:"ghost",size:"icon",onClick:()=>v(n.card_id),className:"rounded-full",tabIndex:-1,children:c.jsx(U,{})}),c.jsx("input",{min:"0",max:"99",type:"text",disabled:!!m.friendId,value:p,onChange:b,className:"w-7 text-center border-none rounded",onFocus:s=>s.target.select()}),c.jsx(k,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>y(n.card_id),tabIndex:-1,children:c.jsx(R,{})})]}):c.jsx("span",{className:"mt-1",children:e})})]})}const A=async(n,l,u,m,t)=>{if(!t||!t.user.email)throw new Error("User not logged in");if(l<0)throw new Error("New amount cannot be negative");const a=[...u],r=n.map(o=>({card_id:o,amount_owned:l,email:t.user.email,updated_at:new Date().toISOString()})),{error:w}=await M.from("collection").upsert(r);if(w)throw new Error("Error bulk updating collection");for(const o of n){const e=a.find(f=>f.card_id===o);e?(console.log("Updating existing card:",o),e.amount_owned=l):e||(console.log("Adding new card:",o),a.push({email:t.user.email,card_id:o,amount_owned:l,updated_at:new Date().toISOString()}))}m([...a])},F=async(n,l,u,m,t)=>{if(!t||!t.user.email)throw new Error("User not logged in");const a=new Map;for(const e of n)a.set(e,(a.get(e)||0)+l);const r=[...u],w=[];for(const[e,f]of a){const p=r.find(g=>g.card_id===e);if(p)console.log("Incrementing existing card:",e,"from",p.amount_owned,"to",p.amount_owned+f),p.amount_owned+=f,p.updated_at=new Date().toISOString(),w.push(p);else if(!p&&f>0){console.log("Adding new card:",e,"with amount",f);const g={email:t.user.email,card_id:e,amount_owned:f,updated_at:new Date().toISOString()};r.push(g),w.push(g)}}const{error:o}=await M.from("collection").upsert(w);if(o)throw new Error(`Error bulk updating collection: ${o.message}`);return m([...r]),w};export{z as C,T as F,R as P,F as i,A as u};
