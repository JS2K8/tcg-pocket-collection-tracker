import{c as L,r as l,m as M,j as c,l as O,b5 as k,J as P,U as $,C as U,B as D,M as B}from"./index-BnFUEHJL.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],T=L("plus",R);function X({selected:n,setIsSelected:r,card:d,size:u="default",clickable:t=!0}){var E;const a=l.useRef(null),[i,w]=l.useState({x:0,y:0}),[o,e]=l.useState(!1),f=l.useRef(Y(m=>w(m),50)),p=m=>{f.current({x:m.clientX,y:m.clientY})},g=l.useCallback(()=>{e(!0),window.addEventListener("mousemove",p)},[]),x=l.useCallback(()=>{e(!1),window.removeEventListener("mousemove",p)},[]);let v=0,y=0;if(a.current&&o){const m=a.current.getBoundingClientRect(),j=m.left+m.width/2,N=m.top+m.height/2;v=i.x-j,y=i.y-N}const b=(m,j,N)=>Math.min(Math.max(m,j),N),s=o?b(v/4,-10,10):0,h=o?b(-y/4,-10,10):0,C={transform:`perspective(1000px)
                   rotateY(${s}deg)
                   rotateX(${h}deg)
                   scale(${o?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:t?"pointer":"default",opacity:n?1:.5,width:u==="small"?"80px":"100%",height:u==="small"?"112px":"auto"},_=(E=d.image)==null?void 0:E.split("/").at(-1),S=`/images/${M.language}/${_}`;return c.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("firefox")?"flat":"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:o?10:0},children:_&&c.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>r==null?void 0:r(!n),ref:a,className:"card-test",style:C,src:S,alt:O(d,M.language),onMouseEnter:g,onMouseLeave:x,onError:m=>{m.target.src=d.image}})})}const Y=(n,r)=>{let d=0,u=null;return(...t)=>{const a=performance.now(),i=a-d;if(i<r){u||(u=setTimeout(()=>{d=performance.now(),u=null,n(...t)},r-i));return}d=a,n(...t)}},I={};function A({card:n,useMaxWidth:r=!1,editable:d=!0}){const u=P();if(n.linkedCardID)return null;const{user:t,setIsLoginDialogOpen:a}=l.use($),{ownedCards:i,setOwnedCards:w,setSelectedCardId:o}=l.use(U),[e,f]=l.useState(n.amount_owned||0),[p,g]=l.useState(0);l.useEffect(()=>{g(e)},[e]);const x=l.useCallback(async(s,h)=>{const C=Math.max(0,h);f(C),I[s]&&window.clearTimeout(I[s]),I[s]=window.setTimeout(async()=>{if(!t||!t.user.email)throw new Error("User not logged in");const _=i.find(E=>E.card_id===s);_?_.amount_owned=C:i.push({email:t.user.email,card_id:s,amount_owned:C,updated_at:new Date().toISOString()});const{error:S}=await k.from("collection").upsert({card_id:s,amount_owned:C,email:t.user.email,updated_at:new Date().toISOString()});if(S)throw new Error("Error updating collection")},1e3)},[i,t,w,e]),v=l.useCallback(async s=>{if(!t){a(!0);return}await x(s,e+1)},[x]),y=l.useCallback(async s=>{if(!t){a(!0);return}await x(s,e-1)},[x]),b=async s=>{const h=s.target.value===""?0:Number.parseInt(s.target.value,10);!Number.isNaN(h)&&h>=0&&await x(n.card_id,h)};return c.jsxs("div",{className:`group flex w-fit ${r?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg`,children:[c.jsx("div",{className:"cursor-pointer",onClick:()=>o(n.card_id),children:c.jsx(X,{card:n,selected:e>0,clickable:!r})}),c.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[n.card_id," - ",O(n,M.language)]}),c.jsx("div",{className:"flex items-center gap-x-1",children:d&&!u.friendId?c.jsxs(c.Fragment,{children:[c.jsx(D,{variant:"ghost",size:"icon",onClick:()=>y(n.card_id),className:"rounded-full",tabIndex:-1,children:c.jsx(B,{})}),c.jsx("input",{min:"0",max:"99",type:"text",disabled:!!u.friendId,value:p,onChange:b,className:"w-7 text-center border-none rounded",onFocus:s=>s.target.select()}),c.jsx(D,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>v(n.card_id),tabIndex:-1,children:c.jsx(T,{})})]}):c.jsx("span",{className:"mt-1",children:e})})]})}const F=async(n,r,d,u,t)=>{if(!t||!t.user.email)throw new Error("User not logged in");if(r<0)throw new Error("New amount cannot be negative");const a=[...d],i=n.map(o=>({card_id:o,amount_owned:r,email:t.user.email,updated_at:new Date().toISOString()})),{error:w}=await k.from("collection").upsert(i);if(w)throw new Error("Error bulk updating collection");for(const o of n){const e=a.find(f=>f.card_id===o);e?(console.log("Updating existing card:",o),e.amount_owned=r):e||(console.log("Adding new card:",o),a.push({email:t.user.email,card_id:o,amount_owned:r,updated_at:new Date().toISOString()}))}u([...a])},H=async(n,r,d,u,t)=>{if(!t||!t.user.email)throw new Error("User not logged in");const a=new Map;for(const e of n)a.set(e,(a.get(e)||0)+r);const i=[...d],w=[];for(const[e,f]of a){const p=i.find(g=>g.card_id===e);if(p)console.log("Incrementing existing card:",e,"from",p.amount_owned,"to",p.amount_owned+f),p.amount_owned+=f,p.updated_at=new Date().toISOString(),w.push(p);else if(!p&&f>0){console.log("Adding new card:",e,"with amount",f);const g={email:t.user.email,card_id:e,amount_owned:f,updated_at:new Date().toISOString()};i.push(g),w.push(g)}}const{error:o}=await k.from("collection").upsert(w);if(o)throw new Error(`Error bulk updating collection: ${o.message}`);return u([...i]),w};export{A as C,X as F,T as P,H as i,F as u};
