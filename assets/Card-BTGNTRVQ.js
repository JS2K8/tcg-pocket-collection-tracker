import{c as U,r as c,v as E,j as m,t as P,an as k,N as B,U as R,C as T,B as L,M as X}from"./index-8_WntPgf.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],D=U("plus",Y);function O({selected:t,setIsSelected:r,card:i,size:a="default"}){var $,I;const n=c.useRef(null),[o,u]=c.useState({x:0,y:0}),[p,e]=c.useState(!1),l=c.useRef(z(d=>u(d),50)),x=d=>{l.current({x:d.clientX,y:d.clientY})},f=c.useCallback(()=>{e(!0),window.addEventListener("mousemove",x)},[]),w=c.useCallback(()=>{e(!1),window.removeEventListener("mousemove",x)},[]);let h=0,_=0;if(n.current&&p){const d=n.current.getBoundingClientRect(),C=d.left+d.width/2,N=d.top+d.height/2;h=o.x-C,_=o.y-N}const v=(d,C,N)=>Math.min(Math.max(d,C),N),s=p?v(h/4,-10,10):0,g=p?v(-_/4,-10,10):0,y={transform:`perspective(1000px)
                   rotateY(${s}deg)
                   rotateX(${g}deg)
                   scale(${p?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:"pointer",opacity:t?1:.5,width:a==="small"?"80px":"100%",height:a==="small"?"112px":"auto"},M=E.language.split("-")[0].toUpperCase(),b=(I=($=i.image)==null?void 0:$.split("/").at(-1))==null?void 0:I.replace(/_[A-Z]{2}\.webp$/,`_${M}.webp`),S=`/images/${E.language}/${b}`;return m.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:p?10:0},children:b&&m.jsx("img",{draggable:!1,onMouseDown:()=>r==null?void 0:r(!t),ref:n,className:"card-test",style:y,src:`${S}`,alt:P(i,E.language),onMouseEnter:f,onMouseLeave:w,onError:d=>{var C;d.target.src=`/images/en-US/${(C=i.image)==null?void 0:C.split("/").at(-1)}`}})})}const z=(t,r)=>{let i=0,a=null;return(...n)=>{const o=performance.now(),u=o-i;if(u<r){a||(a=setTimeout(()=>{i=performance.now(),a=null,t(...n)},r-u));return}i=o,t(...n)}},j={};function A({card:t,useMaxWidth:r=!1}){const i=B();if(t.linkedCardID)return null;const{user:a,setIsLoginDialogOpen:n}=c.use(R),{ownedCards:o,setOwnedCards:u,setSelectedCardId:p}=c.use(T),[e,l]=c.useState(t.amount_owned||0),[x,f]=c.useState(0);c.useEffect(()=>{f(e)},[e]);const w=c.useCallback(async(s,g)=>{l(Math.max(0,g)),j[s]&&window.clearTimeout(j[s]),j[s]=window.setTimeout(async()=>{if(!a||!a.user.email)throw new Error("User not logged in");const y=o.find(b=>b.card_id===s);y?y.amount_owned=Math.max(0,g):o.push({email:a.user.email,card_id:s,amount_owned:g});const{error:M}=await k.from("collection").upsert({card_id:s,amount_owned:g,email:a.user.email});if(M)throw new Error("Error updating collection")},1e3)},[o,a,u,e]),h=c.useCallback(async s=>{if(!a){n(!0);return}await w(s,e+1)},[w]),_=c.useCallback(async s=>{if(!a){n(!0);return}await w(s,e-1)},[w]),v=async s=>{const g=s.target.value===""?0:Number.parseInt(s.target.value,10);!Number.isNaN(g)&&g>=0&&await w(t.card_id,g)};return m.jsxs("div",{className:`group flex w-fit ${r?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[m.jsx("div",{onClick:()=>p(t.card_id),children:m.jsx(O,{card:t,selected:e>0})}),m.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",P(t,E.language)]}),m.jsxs("div",{className:"flex items-center gap-x-1",children:[!i.friendId&&m.jsx(L,{variant:"ghost",size:"icon",onClick:()=>_(t.card_id),className:"rounded-full",tabIndex:-1,children:m.jsx(X,{})}),m.jsx("input",{min:"0",max:"99",type:"text",disabled:!!i.friendId,value:x,onChange:v,className:"w-7 text-center border-none rounded",onFocus:s=>s.target.select()}),!i.friendId&&m.jsx(L,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>h(t.card_id),tabIndex:-1,children:m.jsx(D,{})})]})]})}const H=async(t,r,i,a,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");if(r<0)throw new Error("New amount cannot be negative");const o=[...i],u=t.map(e=>({card_id:e,amount_owned:r,email:n.user.email})),{error:p}=await k.from("collection").upsert(u);if(p)throw new Error("Error bulk updating collection");for(const e of t){const l=o.find(x=>x.card_id===e);l?(console.log("Updating existing card:",e),l.amount_owned=r):l||(console.log("Adding new card:",e),o.push({email:n.user.email,card_id:e,amount_owned:r}))}a([...o])},V=async(t,r,i,a,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");const o=[...i],u=[];for(const e of t){const l=o.find(h=>h.card_id===e),x=(l==null?void 0:l.amount_owned)||0,f=Math.max(0,x+r),w=u.find(h=>h.card_id===e);w?w.amount_owned=f:u.push({card_id:e,amount_owned:f,email:n.user.email}),l?(console.log("Incrementing existing card:",e,"from",x,"to",f),l.amount_owned=f):!l&&f>0&&(console.log("Adding new card:",e,"with amount",f),o.push({email:n.user.email,card_id:e,amount_owned:f}))}const{error:p}=await k.from("collection").upsert(u);if(p)throw new Error("Error bulk updating collection");a([...o])};export{A as C,O as F,D as P,V as i,H as u};
