import{e as L,r as l,t as M,j as p,s as O,bb as N,T as P,U as $,C as T,B as D,M as U}from"./index-DmOp4mTJ.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],R=L("plus",B);function X({selected:t,setIsSelected:r,card:c,size:n="default",clickable:s=!0}){var k;const o=l.useRef(null),[d,g]=l.useState({x:0,y:0}),[e,i]=l.useState(!1),w=l.useRef(Y(u=>g(u),50)),m=u=>{w.current({x:u.clientX,y:u.clientY})},f=l.useCallback(()=>{i(!0),window.addEventListener("mousemove",m)},[]),b=l.useCallback(()=>{i(!1),window.removeEventListener("mousemove",m)},[]);let C=0,_=0;if(o.current&&e){const u=o.current.getBoundingClientRect(),S=u.left+u.width/2,I=u.top+u.height/2;C=d.x-S,_=d.y-I}const a=(u,S,I)=>Math.min(Math.max(u,S),I),x=e?a(C/4,-10,10):0,h=e?a(-_/4,-10,10):0,v={transform:`perspective(1000px)
                   rotateY(${x}deg)
                   rotateX(${h}deg)
                   scale(${e?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:s?"pointer":"default",opacity:t?1:.5,width:n==="small"?"80px":"100%",height:n==="small"?"112px":"auto"},y=(k=c.image)==null?void 0:k.split("/").at(-1),E=`/images/${M.language}/${y}`;return p.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("firefox")?"flat":"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:e?10:0},children:y&&p.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>r==null?void 0:r(!t),ref:o,className:"card-test",style:v,src:E,alt:O(c,M.language),onMouseEnter:f,onMouseLeave:b,onError:u=>{u.target.src=c.image}})})}const Y=(t,r)=>{let c=0,n=null;return(...s)=>{const o=performance.now(),d=o-c;if(d<r){n||(n=setTimeout(()=>{c=performance.now(),n=null,t(...s)},r-d));return}c=o,t(...s)}},j={};function A({card:t,useMaxWidth:r=!1}){const c=P();if(t.linkedCardID)return null;const{user:n,setIsLoginDialogOpen:s}=l.use($),{ownedCards:o,setOwnedCards:d,setSelectedCardId:g}=l.use(T),[e,i]=l.useState(t.amount_owned||0),[w,m]=l.useState(0);l.useEffect(()=>{m(e)},[e]);const f=l.useCallback(async(a,x)=>{const h=Math.max(0,x);i(h),j[a]&&window.clearTimeout(j[a]),j[a]=window.setTimeout(async()=>{if(!n||!n.user.email)throw new Error("User not logged in");const v=o.find(E=>E.card_id===a);v?v.amount_owned=h:o.push({email:n.user.email,card_id:a,amount_owned:h,updated_at:new Date().toISOString()});const{error:y}=await N.from("collection").upsert({card_id:a,amount_owned:h,email:n.user.email,updated_at:new Date().toISOString()});if(y)throw new Error("Error updating collection")},1e3)},[o,n,d,e]),b=l.useCallback(async a=>{if(!n){s(!0);return}await f(a,e+1)},[f]),C=l.useCallback(async a=>{if(!n){s(!0);return}await f(a,e-1)},[f]),_=async a=>{const x=a.target.value===""?0:Number.parseInt(a.target.value,10);!Number.isNaN(x)&&x>=0&&await f(t.card_id,x)};return p.jsxs("div",{className:`group flex w-fit ${r?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[p.jsx("div",{onClick:()=>g(t.card_id),children:p.jsx(X,{card:t,selected:e>0,clickable:!r})}),p.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",O(t,M.language)]}),p.jsxs("div",{className:"flex items-center gap-x-1",children:[!c.friendId&&p.jsx(D,{variant:"ghost",size:"icon",onClick:()=>C(t.card_id),className:"rounded-full",tabIndex:-1,children:p.jsx(U,{})}),p.jsx("input",{min:"0",max:"99",type:"text",disabled:!!c.friendId,value:w,onChange:_,className:"w-7 text-center border-none rounded",onFocus:a=>a.target.select()}),!c.friendId&&p.jsx(D,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>b(t.card_id),tabIndex:-1,children:p.jsx(R,{})})]})]})}const F=async(t,r,c,n,s)=>{if(!s||!s.user.email)throw new Error("User not logged in");if(r<0)throw new Error("New amount cannot be negative");const o=[...c],d=t.map(e=>({card_id:e,amount_owned:r,email:s.user.email,updated_at:new Date().toISOString()})),{error:g}=await N.from("collection").upsert(d);if(g)throw new Error("Error bulk updating collection");for(const e of t){const i=o.find(w=>w.card_id===e);i?(console.log("Updating existing card:",e),i.amount_owned=r):i||(console.log("Adding new card:",e),o.push({email:s.user.email,card_id:e,amount_owned:r,updated_at:new Date().toISOString()}))}n([...o])},H=async(t,r,c,n,s)=>{if(!s||!s.user.email)throw new Error("User not logged in");const o=new Map;for(const i of t)o.set(i,(o.get(i)||0)+r);const d=[...c],g=[];for(const[i,w]of o){const m=d.find(f=>f.card_id===i);if(m)console.log("Incrementing existing card:",i,"from",m.amount_owned,"to",m.amount_owned+w),m.amount_owned+=w,m.updated_at=new Date().toISOString(),g.push(m);else if(!m&&w>0){console.log("Adding new card:",i,"with amount",w);const f={email:s.user.email,card_id:i,amount_owned:w,updated_at:new Date().toISOString()};d.push(f),g.push(f)}}const{error:e}=await N.from("collection").upsert(g);if(e)throw new Error(`Error bulk updating collection: ${e.message}`);return n([...d]),g};export{A as C,X as F,R as P,H as i,F as u};
