import{e as P,r as c,s as S,j as w,q as $,b3 as N,Q as U,U as B,C as R,B as O,M as T}from"./index-Dcd3cSo1.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],Y=P("plus",X);function z({selected:t,setIsSelected:s,card:l,size:n="default",clickable:r=!0}){var k,D;const a=c.useRef(null),[d,g]=c.useState({x:0,y:0}),[e,i]=c.useState(!1),f=c.useRef(A(u=>g(u),50)),m=u=>{f.current({x:u.clientX,y:u.clientY})},p=c.useCallback(()=>{i(!0),window.addEventListener("mousemove",m)},[]),E=c.useCallback(()=>{i(!1),window.removeEventListener("mousemove",m)},[]);let _=0,y=0;if(a.current&&e){const u=a.current.getBoundingClientRect(),C=u.left+u.width/2,j=u.top+u.height/2;_=d.x-C,y=d.y-j}const o=(u,C,j)=>Math.min(Math.max(u,C),j),x=e?o(_/4,-10,10):0,h=e?o(-y/4,-10,10):0,v={transform:`perspective(1000px)
                   rotateY(${x}deg)
                   rotateX(${h}deg)
                   scale(${e?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:r?"pointer":"default",opacity:t?1:.5,width:n==="small"?"80px":"100%",height:n==="small"?"112px":"auto"},I=S.language.split("-")[0].toUpperCase(),b=(D=(k=l.image)==null?void 0:k.split("/").at(-1))==null?void 0:D.replace(/_[A-Z]{2}\.webp$/,`_${I}.webp`),L=`/images/${S.language}/${b}`;return w.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:e?10:0},children:b&&w.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>s==null?void 0:s(!t),ref:a,className:"card-test",style:v,src:`${L}`,alt:$(l,S.language),onMouseEnter:p,onMouseLeave:E,onError:u=>{var C;u.target.src=`/images/en-US/${(C=l.image)==null?void 0:C.split("/").at(-1)}`}})})}const A=(t,s)=>{let l=0,n=null;return(...r)=>{const a=performance.now(),d=a-l;if(d<s){n||(n=setTimeout(()=>{l=performance.now(),n=null,t(...r)},s-d));return}l=a,t(...r)}},M={};function H({card:t,useMaxWidth:s=!1}){const l=U();if(t.linkedCardID)return null;const{user:n,setIsLoginDialogOpen:r}=c.use(B),{ownedCards:a,setOwnedCards:d,setSelectedCardId:g}=c.use(R),[e,i]=c.useState(t.amount_owned||0),[f,m]=c.useState(0);c.useEffect(()=>{m(e)},[e]);const p=c.useCallback(async(o,x)=>{const h=Math.max(0,x);i(h),M[o]&&window.clearTimeout(M[o]),M[o]=window.setTimeout(async()=>{if(!n||!n.user.email)throw new Error("User not logged in");const v=a.find(b=>b.card_id===o);v?v.amount_owned=h:a.push({email:n.user.email,card_id:o,amount_owned:h,updated_at:new Date().toISOString()});const{error:I}=await N.from("collection").upsert({card_id:o,amount_owned:h,email:n.user.email,updated_at:new Date().toISOString()});if(I)throw new Error("Error updating collection")},1e3)},[a,n,d,e]),E=c.useCallback(async o=>{if(!n){r(!0);return}await p(o,e+1)},[p]),_=c.useCallback(async o=>{if(!n){r(!0);return}await p(o,e-1)},[p]),y=async o=>{const x=o.target.value===""?0:Number.parseInt(o.target.value,10);!Number.isNaN(x)&&x>=0&&await p(t.card_id,x)};return w.jsxs("div",{className:`group flex w-fit ${s?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[w.jsx("div",{onClick:()=>g(t.card_id),children:w.jsx(z,{card:t,selected:e>0,clickable:!s})}),w.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",$(t,S.language)]}),w.jsxs("div",{className:"flex items-center gap-x-1",children:[!l.friendId&&w.jsx(O,{variant:"ghost",size:"icon",onClick:()=>_(t.card_id),className:"rounded-full",tabIndex:-1,children:w.jsx(T,{})}),w.jsx("input",{min:"0",max:"99",type:"text",disabled:!!l.friendId,value:f,onChange:y,className:"w-7 text-center border-none rounded",onFocus:o=>o.target.select()}),!l.friendId&&w.jsx(O,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>E(t.card_id),tabIndex:-1,children:w.jsx(Y,{})})]})]})}const V=async(t,s,l,n,r)=>{if(!r||!r.user.email)throw new Error("User not logged in");if(s<0)throw new Error("New amount cannot be negative");const a=[...l],d=t.map(e=>({card_id:e,amount_owned:s,email:r.user.email,updated_at:new Date().toISOString()})),{error:g}=await N.from("collection").upsert(d);if(g)throw new Error("Error bulk updating collection");for(const e of t){const i=a.find(f=>f.card_id===e);i?(console.log("Updating existing card:",e),i.amount_owned=s):i||(console.log("Adding new card:",e),a.push({email:r.user.email,card_id:e,amount_owned:s,updated_at:new Date().toISOString()}))}n([...a])},q=async(t,s,l,n,r)=>{if(!r||!r.user.email)throw new Error("User not logged in");const a=new Map;for(const i of t)a.set(i,(a.get(i)||0)+s);const d=[...l],g=[];for(const[i,f]of a){const m=d.find(p=>p.card_id===i);if(m)console.log("Incrementing existing card:",i,"from",m.amount_owned,"to",m.amount_owned+f),m.amount_owned+=f,m.updated_at=new Date().toISOString(),g.push(m);else if(!m&&f>0){console.log("Adding new card:",i,"with amount",f);const p={email:r.user.email,card_id:i,amount_owned:f,updated_at:new Date().toISOString()};d.push(p),g.push(p)}}const{error:e}=await N.from("collection").upsert(g);if(e)throw new Error("Error bulk updating collection");return n([...d]),g};export{H as C,z as F,Y as P,q as i,V as u};
