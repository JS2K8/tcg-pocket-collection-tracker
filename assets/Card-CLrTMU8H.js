import{e as B,r as c,s as E,j as p,q as U,b3 as I,Q as R,U as T,C as X,B as P,M as Y}from"./index-BUa4kE9K.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],A=B("plus",z);function D({selected:t,setIsSelected:s,card:l,size:n="default",clickable:r=!0}){var $,L;const o=c.useRef(null),[d,g]=c.useState({x:0,y:0}),[e,i]=c.useState(!1),f=c.useRef(O(u=>g(u),50)),w=u=>{f.current({x:u.clientX,y:u.clientY})},m=c.useCallback(()=>{i(!0),window.addEventListener("mousemove",w)},[]),j=c.useCallback(()=>{i(!1),window.removeEventListener("mousemove",w)},[]);let _=0,y=0;if(o.current&&e){const u=o.current.getBoundingClientRect(),C=u.left+u.width/2,N=u.top+u.height/2;_=d.x-C,y=d.y-N}const a=(u,C,N)=>Math.min(Math.max(u,C),N),x=e?a(_/4,-10,10):0,h=e?a(-y/4,-10,10):0,v={transform:`perspective(1000px)
                   rotateY(${x}deg)
                   rotateX(${h}deg)
                   scale(${e?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:r?"pointer":"default",opacity:t?1:.5,width:n==="small"?"80px":"100%",height:n==="small"?"112px":"auto"},M=E.language.split("-")[0].toUpperCase(),b=(L=($=l.image)==null?void 0:$.split("/").at(-1))==null?void 0:L.replace(/_[A-Z]{2}\.webp$/,`_${M}.webp`),S=`/images/${E.language}/${b}`;return p.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:e?10:0},children:b&&p.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>s==null?void 0:s(!t),ref:o,className:"card-test",style:v,src:`${S}`,alt:U(l,E.language),onMouseEnter:m,onMouseLeave:j,onError:u=>{var C;u.target.src=`/images/en-US/${(C=l.image)==null?void 0:C.split("/").at(-1)}`}})})}const O=(t,s)=>{let l=0,n=null;return(...r)=>{const o=performance.now(),d=o-l;if(d<s){n||(n=setTimeout(()=>{l=performance.now(),n=null,t(...r)},s-d));return}l=o,t(...r)}},k={};function H({card:t,useMaxWidth:s=!1}){const l=R();if(t.linkedCardID)return null;const{user:n,setIsLoginDialogOpen:r}=c.use(T),{ownedCards:o,setOwnedCards:d,setSelectedCardId:g}=c.use(X),[e,i]=c.useState(t.amount_owned||0),[f,w]=c.useState(0);c.useEffect(()=>{w(e)},[e]);const m=c.useCallback(async(a,x)=>{const h=Math.max(0,x);i(h),k[a]&&window.clearTimeout(k[a]),k[a]=window.setTimeout(async()=>{if(!n||!n.user.email)throw new Error("User not logged in");const v=o.find(b=>b.card_id===a);v?v.amount_owned=h:o.push({email:n.user.email,card_id:a,amount_owned:h});const{error:M}=await I.from("collection").upsert({card_id:a,amount_owned:h,email:n.user.email});if(M)throw new Error("Error updating collection")},1e3)},[o,n,d,e]),j=c.useCallback(async a=>{if(!n){r(!0);return}await m(a,e+1)},[m]),_=c.useCallback(async a=>{if(!n){r(!0);return}await m(a,e-1)},[m]),y=async a=>{const x=a.target.value===""?0:Number.parseInt(a.target.value,10);!Number.isNaN(x)&&x>=0&&await m(t.card_id,x)};return p.jsxs("div",{className:`group flex w-fit ${s?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg cursor-pointer`,children:[p.jsx("div",{onClick:()=>g(t.card_id),children:p.jsx(D,{card:t,selected:e>0,clickable:!s})}),p.jsxs("p",{className:"max-w-[130px] overflow-hidden text-ellipsis whitespace-nowrap font-semibold text-[12px] pt-2",children:[t.card_id," - ",U(t,E.language)]}),p.jsxs("div",{className:"flex items-center gap-x-1",children:[!l.friendId&&p.jsx(P,{variant:"ghost",size:"icon",onClick:()=>_(t.card_id),className:"rounded-full",tabIndex:-1,children:p.jsx(Y,{})}),p.jsx("input",{min:"0",max:"99",type:"text",disabled:!!l.friendId,value:f,onChange:y,className:"w-7 text-center border-none rounded",onFocus:a=>a.target.select()}),!l.friendId&&p.jsx(P,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>j(t.card_id),tabIndex:-1,children:p.jsx(A,{})})]})]})}const V=async(t,s,l,n,r)=>{if(!r||!r.user.email)throw new Error("User not logged in");if(s<0)throw new Error("New amount cannot be negative");const o=[...l],d=t.map(e=>({card_id:e,amount_owned:s,email:r.user.email})),{error:g}=await I.from("collection").upsert(d);if(g)throw new Error("Error bulk updating collection");for(const e of t){const i=o.find(f=>f.card_id===e);i?(console.log("Updating existing card:",e),i.amount_owned=s):i||(console.log("Adding new card:",e),o.push({email:r.user.email,card_id:e,amount_owned:s}))}n([...o])},q=async(t,s,l,n,r)=>{if(!r||!r.user.email)throw new Error("User not logged in");const o=new Map;for(const i of t)o.set(i,(o.get(i)||0)+s);const d=[...l],g=[];for(const[i,f]of o){const w=d.find(m=>m.card_id===i);if(w)console.log("Incrementing existing card:",i,"from",w.amount_owned,"to",w.amount_owned+f),w.amount_owned+=f,g.push(w);else if(!w&&f>0){console.log("Adding new card:",i,"with amount",f);const m={email:r.user.email,card_id:i,amount_owned:f};d.push(m),g.push(m)}}const{error:e}=await I.from("collection").upsert(g);if(e)throw new Error("Error bulk updating collection");return n([...d]),g};export{H as C,D as F,A as P,q as i,V as u};
